firebase.initializeApp({apiKey:"AIzaSyBebYtKOqOxENgVbTfiNhWAxh4cr_Vn7Ec",authDomain:"rewards-cee1a.firebaseapp.com",databaseURL:"https://rewards-cee1a.firebaseio.com",projectId:"rewards-cee1a",storageBucket:"rewards-cee1a.appspot.com",messagingSenderId:"376174432289"});const app=angular.module("rewards",["ngSanitize"]),emoji=new EmojiConvertor;if(app.filter("emojis",["$sce",function(e){return r=>{const a=emoji.replace_colons(r);return a!==r?e.trustAsHtml(a):""}}]),app.filter("length",function(){return function(e){return Object.keys(e||{}).length}}),app.factory("emojiService",[()=>({replace_mode:emoji.replace_mode})]),"rewards.io"===window.location.hostname){const e="4201";var livereload=document.createElement("script");livereload.setAttribute("src","http://127.0.0.1:"+e+"/livereload.js"),document.head.appendChild(livereload)}app.controller("LeaderboardController",["$scope","$log","leaderboardService","configService","emojiService",(e,r,a,t,o)=>{const i=["image_1024","image_512","image_original"];e.emoji=o,e.config=t,e.fetchLeaderboard=(()=>{a.getValid().then(r=>{e.leaderboard=r.data})}),e.hasImage=(e=>Object.keys(e).some(e=>i.indexOf(e)>0)),e.getImage=(e=>{let r="";return i.forEach(a=>{void 0!==e[a]&&(r=e[a])}),r}),e.fetchLeaderboard()}]),app.controller("RewardsController",["$scope","$log","rewardsService","emojiService",(e,r,a,t)=>{e.emoji=t,e.newReward=null,e.fetchRewards=(()=>{e.newReward=null,a.getAll().then(r=>{e.newReward=angular.copy(a.reward({name:"New Reward"})),Object.keys(r.data).forEach(e=>{r.data[e].id=e}),e.rewards=r.data})}),e.fetchRewards(),e.redeem=(e=>a.redeem(e))}]),app.directive("rewardCard",()=>({controller:["$log","$scope","$element","rewardsService","configService",(e,r,a,t,o)=>{r.config=o,r.updating=!1,r.uploading=!1,r.choosing_options=!1,r.reward_options_steps={},r.reward_options_selected=[],r.show_options=!1,r.isAdmin=void 0!==a.attr("is-admin"),r.reward&&!r.isNew||(r.reward=t.reward({name:"New Reward"}),r.btnMessage="New"),r.available=void 0!==r.reward.stock?r.reward.stock>0:0;let i=angular.copy(r.reward);r.reward.image&&t.getImageUrl(r.reward.image).then(e=>{r.imageURL=e,r.$apply()}).catch(()=>{r.imageURL=null,r.$apply()}).finally(()=>{r.imageLoaded=!0,r.$apply()}),r.save=(()=>{r.updating=!0,r.uploading=!0;let{key:e}=r;r.isNew&&(e=null),t.update(e,r.reward,r.changedProperties()).then(()=>{i=angular.copy(r.reward)}).finally(()=>{r.isNew&&"function"==typeof r.onNew&&r.onNew(),r.uploading=!1,r.updating=!1,r.cancel(),r.$apply()})}),r.edit=(()=>{r.updating=!0}),r.cancel=(()=>{r.reward=angular.copy(i),r.updating=!1}),r.remove=(()=>{t.remove(r.key).then(()=>{"function"==typeof r.onRemove&&r.onRemove()})});const l=["detail","image","name","price","unique","stock","options"];r.changedProperties=(()=>l.filter(e=>void 0===l[e]&&void 0!==r.reward[e]).filter(e=>i[e]!==r.reward[e]).filter(e=>"object"!=typeof r.reward[e]||(void 0!==i[e]||void 0!==r.reward[e])&&JSON.stringify(i[e])!==JSON.stringify(r.reward[e]))),r.hasChanged=(()=>r.changedProperties().length>0),r.$watch(()=>r.reward.image,(e,a)=>{void 0===e||null===e||void 0!==a&&null!==a||r.edit(),void 0!==e&&null!==e||void 0===a||null===a||r.cancel()}),r.showOptions=(()=>{let e={};Object.values(r.reward.options).forEach(r=>{if(r.match(/^(\d+):([\s\S]+)/g)){var a=/^(\d+):([\s\S]+)$/g.exec(r);void 0===e[a[1]]&&(e[a[1]]=[]),e[a[1]].push(a[2])}else Array.isArray(e)||(e=[]),e.push(r)}),Array.isArray(e)?r.reward_options_steps=[e]:r.reward_options_steps=Object.values(e),r.reward_options_selected=[],r.show_options=!0}),r.optionsSelected=(()=>(r.reward_options_selected.length>=r.reward_options_steps.length&&(r.choosing_options=!1),r.reward_options_selected.length>=r.reward_options_steps.length)),r.redeem=(()=>{r.reward.options?r.choosing_options?r.optionsSelected()&&(r.choosing_options=!1,r.reward.options=r.reward_options_selected,r.redeemReward()):(r.choosing_options=!0,r.showOptions()):r.redeemReward()}),r.redeemReward=(()=>{r.updating=!0,t.redeem(r.reward).finally(()=>{r.cancel()})})}],restrict:"E",scope:{isNew:"=?",key:"=?",onNew:"&?",onRemove:"&?",reward:"=?"},templateUrl:"/templates/rewardCard.html"})),app.directive("rewardChips",()=>({controller:["$log","$scope","$element","configService",(e,r,a,t)=>{r.config=t,r.unique=void 0===r.unique||r.unique;const o=["Tab","Enter",","],i=a.find("input");r.chips=void 0!==r.ngModel?Object.values(r.ngModel):[],r.addChip=(()=>{r.chips.push(r.selectedChip),r.setValue(),r.selectedChip=""}),r.setValue=(()=>{const e={};r.chips.forEach((r,a)=>{e[a]=r}),r.ngModel=e}),r.textAreaClick=(()=>{i[0].focus()}),r.deleteChip=((e,a)=>{a.preventDefault(),a.stopPropagation(),r.chips.splice(r.chips.indexOf(e),1),r.setValue()}),r.keydown=(e=>{if(o.indexOf(e.key)>=0&&r.selectedChip.length){if(r.unique&&r.chips.indexOf(r.selectedChip)>=0)return;e.preventDefault(),e.stopPropagation(),r.addChip()}})}],restrict:"E",scope:{ngModel:"=",unique:"@"},templateUrl:"/templates/rewardChips.html"})),app.directive("rewardOptions",()=>({controller:["$log","$scope","$element","configService",(e,r,a,t)=>{r.config=t,r.selectOption=((e,a)=>{const t=angular.element(e.target);angular.element(t).parent().find("span").removeClass("active"),angular.element(t).addClass("active"),r.ngModel=a})}],restrict:"E",scope:{ngModel:"=",options:"&"},templateUrl:"/templates/rewardOptions.html"})),app.directive("storageImage",()=>({controller:["$log","$scope","$element","rewardsService",(e,r,a,t)=>{r.loaded=!1,r.src=r.url,r.load=(()=>{t.getImageUrl(r.url).then(e=>{r.image_url=e,r.$apply()}).catch(()=>{r.image_url=null,r.$apply()}).finally(()=>{r.loaded=!0,r.$apply()})}),r.$watch(()=>r.url,e=>{e&&"string"==typeof e&&r.load()}),r.load()}],restrict:"E",scope:{url:"="},templateUrl:"/templates/storageImage.html"})),app.directive("uploadFile",()=>({controller:["$log","$scope","$element","rewardsService",(e,r,a)=>{r.previewUrl=null,r.previewName=null,r.preview=!1;const t=angular.copy(r.url);r.setImage=(e=>{r.previewUrl=e,r.preview=!0,r.$apply()}),r.cancel=(()=>{r.previewUrl=null,r.previewName=null,r.preview=!1,r.url=void 0!==t?t:null,angular.element(a.find("input")).val("")}),r.processFile=(e=>{if(1!=e.files.length)return;var a=new FileReader;a.onload=function(e){r.setImage(e.target.result)};const[t]=e.files;a.readAsDataURL(t),r.previewName=t.name,r.url=t,r.$apply()}),r.$watch("url",e=>{void 0!==e&&null!==e||r.cancel()})}],restrict:"E",scope:{url:"="},templateUrl:"/templates/uploadFile.html"})),app.factory("configService",[()=>({title:"Enroute Rewards",keyword:{token:":taco:",singular:"taco",plural:"tacos"}})]);const LEADERBOARD_ENDPOINT="/leaderboard/";app.factory("leaderboardService",["$log","$http",(e,r)=>({get:e=>r.get(`/leaderboard//${e}`),getAll:()=>r.get("/leaderboard/all"),getValid:()=>r.get("/leaderboard/valid")})]);const REWARDS_ENDPOINT="/rewards";app.factory("rewardsService",["$log","$http",(e,r)=>({get:e=>r.get(`/rewards/${e}`),getAll:()=>r.get("/rewards/all"),getImageUrl:e=>firebase.storage().ref().child(e).getDownloadURL(),redeem:e=>r.post("/rewards/redeem",e),remove:e=>r.delete(`/rewards/delete/${e}`),reward:e=>{return new function(e){Object.assign(this,e)}(e)},update:(a,t,o)=>{e.log("changes",o);const i=firebase.storage();if(t.key=a,o.indexOf("image")>-1){const e=`images/rewards/${Number(new Date)}-${t.image.name}`,a=i.ref().child(e);return new Promise(function(o,i){a.put(t.image).then(()=>{t.image=e,o(r.post("/rewards/update",t))}).catch(e=>{i(e)})})}return r.post("/rewards/update",t)}})]);